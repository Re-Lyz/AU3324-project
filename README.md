# 引言

伺服电机是一种高性能的闭环控制电机，广泛应用于精密运动控制领域，例如工业自动化、机器人技术以及数控机床等。其特点包括高精度的位置反馈、稳定的速度控制以及优异的动态响应能力。伺服电机常常作为驱动系统的核心部件，提供精确的定位控制，适用于对高可靠性和高精度要求的各种应用。

本项目基于RS485通信协议设计并实现了一个伺服电机控制系统。RS485通信协议具有较强的抗干扰能力、较长的传输距离和支持多设备网络控制的优点，使其在工业控制中具有广泛应用。在该项目中，使用ESP32微控制器与伺服电机进行通信，并利用该微控制器实现对电机的精确控制。

项目的主要目标包括：

- 通过RS485协议与伺服电机进行数据交换，实现电机的闭环控制。

- 设计并实现一个控制算法，确保电机能够执行精确的180°旋转动作，同时可以使用梯形运动曲线和s型运动曲线。

- 使用MPU6050传感器，设计闭环控制算法，保持电机末端执行器的水平位置。

- 显示电机的速度轨迹和实时数据，通过OLED显示屏展示电机状态。

- 实现Wi-Fi与蓝牙功能，扩展伺服电机的控制方式。

- 分析并优化PID控制器的P、I、D参数，以提高电机控制的精度和稳定性。

- 分析单环控制与双环控制之间的差异，分析前馈量对运动所带来的影响。

- 实现额外的一些自定义功能，如模式功能切换等功能。

通过完成本项目，旨在提升伺服电机控制系统的理解与应用能力，探索RS485通信在伺服电机控制中的实际应用，并为工业自动化系统中的伺服电机控制提供一种高效且稳定的解决方案。

# 硬件连接

硬件连接方式如图所示，各个硬件均可以正常运行。

![](D:\lyz\学校相关\电\运动控制系统\AU3324-project\figures\hardware.png)

硬件连接示意图

# 闭环控制算法

本章分别介绍两种关键控制策略：180°精确旋转控制与伺服电机水平位置维持。

## 180° 精确旋转控制

### 运行模式选择

运行模式：速度模式  
选择速度模式的主要原因在于为了实现实时的pid控制，根据手册《RS485 Servo Motor Communication Manual》中的说明，位置模式下速度相关参数必须在停机之后才可以运行，尽管位置模式下的开环控制可以实现很精准的180°旋转（详见附件“多段位置开环.mp4”），但是无法实现实时调整。同时转矩模式并不符合控制速度的要求，只有速度模式在运行过程中可以实时修改目标速度，满足要求，因此在运动模式选择此处选择速度模式。

![](D:\lyz\学校相关\电\运动控制系统\AU3324-project\figures\speedmode.png)

伺服电机速度模式参数设置

### 初始参数设置

初始参数的设计主要基于伺服电机的最小分度值，保证在最小运动单元下仍能精确控制。 根据上图得最小速度分辨率和最小加速度分辨率，分别为:

``` math
\Delta\omega_{\min}=1\ rpm,\quad
\Delta a_{\min}=0.1\ rps/s,.
```

为了让运动曲线在最小分度下依然平滑，我们的初始参数必须是上述最小分辨率的整数倍。

#### 梯形速度曲线特征

梯形曲线由三个阶段组成：

1.  *恒加速阶段*：以常数加速度 $`r_a`$ 从 0 加至目标速度；

2.  *恒速阶段*：以恒定速度 $`v_{\max}`$ 运行；

3.  *恒减速阶段*：以常数减速度 $`r_d`$ 从 $`v_{\max}`$ 匀减至 0 停止。

该曲线实现简单、计算量小，但在加减速拐点处加速度存在突变。  

#### S 型速度曲线特征

S 型曲线在加减速段内部进一步限制“跃变斜率”（jerk），将加速度也作平滑过渡：

1.  *加速上升段*：以斜率 $`j_{\rm acc}`$ 平稳提升加速度；

2.  *恒定加速段*：以常数加速度 $`r_a`$ 加速至 $`v_{\max}`$；

3.  *加速下降段*：以斜率 $`-j_{\rm acc}`$ 慢慢将加速度降至 0，进入恒速；

4.  *减速过程*：镜像加速过程，平滑过渡至停止。

此曲线能显著减小机械冲击，但计算复杂度更高。

#### 参数选取

综合最小分度原则与以上曲线特性，我们设定了以下两组初始参数进行对比：

``` c++
TrapezoidalProfile trapezoidal(0.5, 0.5, 0.5, 30, 10, 10);
SCurveProfile sCurve(0.5, 0, 0.5, 10, 0);
```

其中参数按照顺序含义依次如下：

- **梯形曲线（Trapezoidal Profile）**

  - 加速阶段时间 $`t_{\rm acc}`$：需满足最小速度增量 $`\Delta\omega_{\min}`$ 与最小加速度 $`a_{\min}`$ 的关系

    ``` math
    t_{\rm acc}\;\ge\;\frac{\Delta\omega_{\min}}{a_{\min}};
    ```

  - 匀速阶段时间 $`t_{\rm const}`$：保证足够的运动距离；

  - 减速阶段时间 $`t_{\rm dec}`$：可与加速阶段对称或少量调整；

  - 峰值速度 $`\omega_{\max}`$：取额定转速（rpm）的中等值，以兼顾响应速度与稳定性；

  - 加速度 $`a`$、减速度 $`d`$：设为最小加速度分辨率（单位 $`0.1\,\mathrm{rps/s}`$）的整数倍。

- **S 曲线（S‑Curve Profile）**

  - 上升斜坡时间 $`t_r`$；

  - 恒定加速时间 $`t_{\rm const}`$；

  - 下降斜坡时间 $`t_{r,\rm down}`$ ；

  - 最大加速度 $`A_{\max}`$：同样与最小分辨率对齐；

  - 匀速时间 $`t_{\rm cv}`$：依据行程和速度需求确定；

这样既能保证运动稳定，又保证参数与伺服电机最小分度对齐，后续可在此基础上微调 PID 等控制器参数。

### PID控制策略（单环、双环、前馈）

为了实现对伺服系统的高精度、高响应控制，我们在基础的 PID 控制框架下逐步引入双环结构和前馈补偿，具体分为以下三种策略：

#### 单环 PID 控制

单环 PID 控制仅在位置环路上引入PID调节器，典型结构如下图所示：

``` math
u(t)=K_P e(t)+K_I\int_0^t e(\tau)\,\mathrm{d}\tau + K_D \frac{\mathrm{d}e(t)}{\mathrm{d}t},\quad
e(t)=r(t)-y(t),
```

其中 $`r(t)`$ 为设定值，$`y(t)`$ 为反馈值，$`u(t)`$ 为控制量。

- 优点：结构简单，实现方便。

- 缺点：当负载或动态变化较大时，难以兼顾快速响应与稳态精度，易产生超调或稳态误差。

#### 双环 PID 控制

双环 PID 在单环基础上增设外环（位置／角度环）和内环（速度／转速环）两级调节：

``` math
\begin{cases}
e_p(t)=r_p(t)-y_p(t),& v^*(t)=\mathrm{PID}_p\bigl(e_p(t)\bigr),\\
e_v(t)=v^*(t)-y_v(t),& u(t)=\mathrm{PID}_v\bigl(e_v(t)\bigr).
\end{cases}
```

- 外环：位置误差经位置 PID 得到速度设定 $`v^*`$，保证精确定位。

- 内环：速度误差经速度 PID 得到加／减速指令 $`u`$，提高动态响应速度。

- 优点：内环快速、抗干扰，外环稳态精度高，兼顾速度与位置控制要求。

#### 前馈–PID 混合控制

在双环 PID 之上加入前馈环节，根据期望轨迹的速度、加速度计算出前馈控制量 $`u_{\rm ff}(t)`$，总控制量为

``` math
u(t)=u_{\rm ff}(t)+u_{\rm fb}(t),
```

其中

``` math
u_{\rm ff}(t)=K_v\,\dot r(t)+K_a\,\ddot r(t)
```

可直接抵消已知的动态负载，$`u_{\rm fb}(t)`$ 为上述单环或双环 PID 输出。大幅提高跟踪精度，减小超调和迟滞；在大负载突变时依然保持快速准确响应。。

## 水平位置保持

为了使末端始终保持水平姿态，系统需要在合适的运动模式下结合惯性测量输出，利用 PID 控制完成姿态维持。

### 运动模式选择

伺服电机支持位置模式、速度模式和力矩模式三种控制方式。对水平保持而言，我们更关注姿态角度偏差的实时修正，因此选用位置模式作为主控模式：

位置模式：通过给定目标角度（小范围位置指令），电机闭环驱动到对应位置，从而实现角度修正。

相比之下，速度模式和力矩模式虽可用于跟踪角速度或力矩补偿，但姿态保持精度较位置模式稍逊，且需要额外的外环解析。

因此，本系统将伺服电机设为位置模式，多段位置模式或单段位置模式均可，根据实际调试决定。

### 倾斜角度获取

为实现对机体倾斜角度的高精度测量，本设计采用了 `MPU6050_tockn.h` 库，而非传统的 `MPU6050.h`。该库内置了基于 DMP（Digital Motion Processor）的姿态解算以及互补滤波算法，大幅提高了角度解算的精度和稳定性。调用方式示例如下：

``` c++
// 引入 TOCKN 封装的 MPU6050 库
#include <MPU6050_tockn.h>
#include <Wire.h>

MPU6050 mpu6050(Wire);

void setup() {
  Wire.begin();
  Serial.begin(115200);
  mpu6050.begin();            // 初始化传感器
  mpu6050.calcGyroOffsets(true);  // 自动校准陀螺零偏
}

void loop() {
  mpu.update();
  float pitch = mpu.getAngleX();
  
}
```

与仅用 `MPU6050.h` 库手动实现互补滤波不同，`MPU6050_tockn` 库的 DMP 解算可自动在 200Hz 以上频率下完成陀螺仪与加速度计数据融合，滤波常数及零偏校准均在内部处理，输出角度精度能达到 $`\pm0.1^\circ`$ 级别，显著优于手工滤波（$`\pm1^\circ`$ 以上波动）。因此，本系统在倾斜检测环节选用该库，可保证姿态信息既高频响应又低噪声漂移，为后续 PID 控制提供了可靠的输入。

### PID 控制（单环 / 双环）

基于上述角度反馈，引入 PID 控制策略，实现水平保持：

- **单环 PID**：直接将角度偏差 $`e_\phi = \phi_{\rm set}-\phi`$ 送入 PID，产生位置修正量 $`\Delta \theta`$：

  ``` math
  \Delta \theta(t) = K_P e_\phi + K_I\!\int e_\phi\,dt + K_D\frac{d e_\phi}{dt}\,.
  ```

  优点：结构简单；缺点：动态响应与抗扰性能有限。

- **双环 PID**：在单环基础上再加速度环——

  1.  *外环（角度环）*：$`e_\phi`$ 经角度 PID 得到目标角速度 $`\omega^*`$；

  2.  *内环（速度环）*：速度偏差 $`e_\omega=\omega^*-\omega`$ 经速度 PID 得到位置增量。

  双环结构使内环对速度的快速跟踪抑制了扰动，外环保证了稳态角度精度。

通过上述三步——位置模式、角度获取、PID（单环或双环）——即可建立一套鲁棒的水平姿态保持方案。

### 无线通信模块

无线通信模块采用Node.js与Vue技术栈，通过后端Node.js提供REST接口和WebSocket，将伺服电机的速度曲线、加速度曲线及实时状态推送至前端，并接收前端下发的运动命令。前端基于Vue框架完成界面渲染与数据展示。当蓝牙和Wi-Fi同时可用时，系统可按照预设优先级在两种通道间自动切换，以保证命令的可靠传输和实时响应。由于该部分并非本人主要负责，以上内容仅作简要说明。

![](D:\lyz\学校相关\电\运动控制系统\AU3324-project\figures\webDisplay.png)

web端示意图

# PID参数影响分析

PID参数的影响分析主要在单闭环控制下研究，我们在相同的测试环境下对比了多组参数的调整效果。PID参数的调试流程如下：首先保持积分和微分系数为零，仅调整比例系数$`K_p`$，直至系统在目标速度下能够稳定运行；然后根据运动曲线和串口反馈中实际速度与理论速度的滞后情况，逐步增加微分系数$`K_d`$，以改善速度修正的及时性；最后适当增大积分系数$`K_i`$，以消除稳态误差并抑制残余抖动。

在初步设置合适的$`K_p`$后，系统存在明显超调现象；通过观察速度曲线与串口反馈发现输出速度修正迟滞，为此分别将$`K_d`$由0.00增至0.01、0.02，直至0.05时，滞后现象明显改善。此时又在运动末端出现小幅震荡，于是将$`K_i`$由0.00微调至0.005，以抑制稳态误差并减小振荡。最终在不同运动曲线下得到以下PID参数配置：

|   运动模式   | $`K_p`$ | $`K_i`$ | $`K_d`$ |
| :----------: | :-----: | :-----: | :-----: |
| 梯形曲线模式 |    2    |  0.03   |  0.05   |
|  S 曲线模式  |    1    |  0.03   |   0.1   |
| 水平平衡模式 |    1    |  0.01   |  0.05   |

单环运动模式下PID参数设置

当然，实验结果表明，单环控制仍然存在一定的不稳定性（详见附件视频“单环180°.mp4”等），之后会在下一节讨论控制模式的影响。

下表总结了比例、积分、微分三项参数增减对系统性能的主要影响：

|  参数   |          增大后          |        减小后        |       备注       |
| :-----: | :----------------------: | :------------------: | :--------------: |
| $`K_p`$ |  响应速度加快，超调增大  |  响应变慢，超调减小  | 主导系统收敛速度 |
| $`K_i`$ | 消除稳态误差，易引入震荡 | 稳定性提高，欠调明显 | 用于消除残余偏差 |
| $`K_d`$ | 抑制超调与振荡，响应平滑 |    对扰动修正滞后    | 改善系统阻尼特性 |

PID参数增减对系统性能的影响

# 控制方式比较

在本节中，我们对比了三种常见的伺服控制方式：单闭环位置控制、双闭环位置—速度控制，以及带前馈补偿的双闭环控制。单闭环位置控制结构简单，只包含位置环，通过调节位置误差来驱动电机；双闭环控制在位置环之外增加速度环，以更快地响应速度误差并对位置环输出进行滤波；前馈补偿则在双闭环基础上，将运动学模型计算得到的理论速度作为附加输入引入速度环，以期进一步改善动态性能。

在 $`180^\circ`$ 精确旋转实验中，单闭环控制存在较大的超调和后冲现象，且速度曲线抖动明显；而采用双闭环控制后，位置跟踪误差和速度扰动均显著减小，运动过程更加平滑（详见附件视频“双环180°.mp4”等）。其原因在于速度环对速度误差进行了及时修正，提升了系统阻尼特性并加快了动态响应。双闭环的PID参数设置如表 [1](#tab:double_loop_pid) 所示。

|      回路      | $`K_p`$ | $`K_i`$ | $`K_d`$ |
| :------------: | :-----: | :-----: | :-----: |
| 梯形曲线速度环 |    1    |  0.00   |  0.05   |
|  S 曲线速度环  |    1    |  0.01   |  0.00   |

双闭环位置—速度控制的PID参数设置

在水平保持实验中，单闭环同样难以抵抗外界扰动，出现明显倾斜偏差；双闭环控制则利用速度环的快速反馈，能够在扰动发生后更快地恢复平衡，倾斜角度趋近于零。理论上，速度环提供了对转动惯量和摩擦影响的补偿，延缓了位置环的过度响应，从而抑制了振荡。

在水平保持实验中，速度环的PID参数设置如表 [2](#tab:horizontal_speed_pid) 所示。

|  回路  | $`K_p`$ | $`K_i`$ | $`K_d`$ |
| :----: | :-----: | :-----: | :-----: |
| 速度环 |    1    |   0.0   |  0.05   |

水平保持速度环PID参数设置

最后，我们在双闭环结构中加入了简单的前馈补偿：利用运动规划中计算得到的理论速度作为速度环的前馈输入，以期在跟踪运动时减少速度误差。实验结果表明（详见视频"前馈+双环180°.mp4"），前馈虽使上升沿略有加快，但整体跟踪误差改善有限。这可能是由于模型与实际系统存在差异，且前馈增量相对较小，在扰动和非线性因素面前作用有限所致。

# 额外功能

## 运动功能切换

在本系统中，我们引入了云端模式切换功能，使得运动模式的切换变得简便而灵活。用户只需在前端界面上点击对应按钮，系统便会通过 HTTP 请求将新的模式指令发送至云端服务器。云端接收到切换请求后，立即将相应的控制参数下发到设备端，舵机控制单元即可从水平平衡模式切换到 180° 旋转模式。整个切换过程无需本地重新编译或手动配置，极大地提升了使用体验与操作效率。（详见视频“模式切换功能.mp4”）

# 结论

本项目成功设计并实现了一套基于RS485总线与ESP32控制器的伺服电机闭环控制系统，主要成果如下：

- **180°精确旋转控制**：在速度模式下，分别实现了梯形与S型两种运动曲线，使电机在180°旋转过程中加减速较为平滑，经多次实验验证角度误差小于5°；

- **水平位置保持**：结合MPU6050模块的DMP姿态解算，实现了基于位置模式的单环／双环PID控制，系统在外界扰动下即时恢复，水平偏差保持在$`\pm1^\circ`$以内；

- **PID参数调优与控制方式比较**：系统性地分析了单闭环、双闭环及前馈–双闭环三种策略的性能差异，验证了双闭环结构在抗干扰与动态响应方面的优势，并探索了前馈补偿对跟踪精度的提升空间；

- **可视化与通信扩展**：通过OLED屏实时绘制速度曲线，并实现了Wi-Fi与蓝牙双模切换，支持云端RESTful接口与WebSocket推送，增强了远程监控与交互体验；

- **自定义功能**：开发了多段位置／速度模式切换与云端模式指令下发机制，实现了运行模式的在线无缝切换，提升了系统的灵活性与扩展性。

同时也在此总结本项目中的一些经验供参考：

1.  在初始化RS485通信时，程序初始化的端口和TTL2RS485模块与ESP32之间的接线过程中的端口是相反的。

2.  伺服电机的波特率建议设置在115200以提高通讯速度。

3.  导入蓝牙和WiFi模块时，可以把partition scheme设置成minimal SPIFFS减少内存占用。

4.  每次读取伺服电机的数据时，需要适当的delay()一定时间。

最后在此列举项目的改进方向：

- 综合PID调参策略：在双环控制中，本次项目是冻结了外部位置环参数，仅调整速度环参数，可以同时联合调整内环（速度环）与外环（位置环）PID参数，发挥协同效应，进一步提升系统性能；

- 循环运动超调现象分析：针对梯形运动曲线循环执行时，首次运行结果准确，而后续出现超调的问题，需深入研究累积误差与动态响应差异的产生机制；

- 前馈补偿参数化：在前馈量中引入比例因子$`\alpha`$ ，对速度和加速度前馈分量进行加权调节，以改善跟踪精度与系统稳定性；

- 云端实时调参功能：引入云端界面或API，支持在线修改PID参数并即时生效，减少反复烧录固件的次数，提升调试与迭代效率。

# 附件说明

本报告所附材料分为两大类：代码部分与实验视频结果，具体说明如下：

1.  **代码部分**  
    附录A 中给出了本项目的完整 Arduino 源码，代码已开源在<https://github.com/Re-Lyz/AU3324-project>，包括：

    - 主控逻辑——ESP32 上的 RS485 通信与各模式切换以及各个模式的详细实现；

    - 前端实现——基于 Node.js 与 Vue 的云端控制与可视化界面代码。

2.  **视频结果**  
    实验视频共 8 段，分别演示了各控制策略与功能模块的实际效果：

    - `单环180°.mp4`：单闭环位置模式下执行 180° 旋转的速度曲线；

    - `单环水平保持.mp4`：单闭环 PID 控制下末端执行器水平姿态的保持过程；

    - `多段位置开环.mp4`：多段位置模式（开环）按预设段号顺序运动的轨迹演示；

    - `模式切换功能.mp4`：云端/前端实时下发指令切换运动模式的在线切换过程；

    - `前馈+双环180°.mp4`：在前馈补偿基础上结合双闭环控制执行 180° 旋转的跟踪效果；

    - `双环180°.mp4`：双闭环位置–速度控制下执行 180° 旋转时的跟踪效果；

    - `双环水平保持.mp4`：双闭环控制体系下水平姿态的保持过程；

    - `云端监控.mp4`：Web 端实时监控界面展示伺服电机速度、加速度曲线及状态推送效果。
